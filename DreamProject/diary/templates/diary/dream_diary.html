{% extends 'diary/base.html' %}
{% load static %}

{% block title %}Journal de rêves{% endblock %}

{% block content %}

<!-- Bloc profil -->
<div class="flex flex-col items-center justify-center text-center gap-2 mb-10">

  <!-- Image de profil avec effet "trou" -->
  <div class="relative w-32 h-32">
    <div class="rounded-full overflow-hidden w-full h-full">
      {% if user.profile_picture %}
        <img src="{{ user.profile_picture.url }}" alt="Profil"
             class="w-full h-full object-cover rounded-full" />
      {% else %}
        <img src="{% static 'img/profil_placeholder.png' %}" alt="Profil"
             class="w-full h-full object-cover rounded-full" />
      {% endif %}
      <div class="absolute inset-0 inset-shadow"></div>
    </div>
  </div>

  <!-- Nom -->
  <h2 class="text-[1.3rem] font-semibold text-gray-800">{{ user.username }}</h2>

  <!-- Bio avec guillemets -->
  <div class="relative w-full flex justify-center">
    <div class="relative max-w-[70%] text-center">
      <img src="{% static 'img/left_quotation_marks.png' %}" alt="Guillemet gauche"
           class="absolute top-1/2 -translate-y-1/2 -left-4 w-[1.35rem]" />
      <img src="{% static 'img/right_quotation_marks.png' %}" alt="Guillemet droit"
           class="absolute top-1/2 -translate-y-1/2 -right-4 w-[1.35rem]" />
      <p class="text-[0.95rem] text-black font-normal leading-tight px-6">
        La nuit, je deviens l'héroïne de mondes silencieux.
      </p>
    </div>
  </div>
</div>


<!-- Suivi personnel -->

<div class="grid grid-cols-3 gap-6 mt-8 mb-4">

    <!-- Rêves/cauchemars -->
    <div class="text-center pastel-yellow mb-6">
      <h2 class="text-xs sm:text-sm md:text-base font-normal">Profil onirique</h2>
      <p class="text-sm sm:text-base md:text-lg font-semibold text-black">{{ statut_reveuse }}</p>
      <p class="text-xs sm:text-xs md:text-sm text-gray-500 mt-1">
        {{ pourcentage_reveuse }}% de {{ label_reveuse }}
      </p>
    </div>

    <!-- Émotion dominante -->
    <div class="text-center pastel-vanilla mb-6">
      <h2 class="text-xs sm:text-sm md:text-base font-normal">Émotion dominante</h2>
      <p class="text-sm sm:text-base md:text-lg font-semibold text-black">{{ emotion_dominante }}</p>
      <p class="text-xs sm:text-xs md:text-sm text-gray-500 mt-1">
        dans {{ emotion_dominante_percentage }}% des cas
      </p>
    </div>

    <!-- Thématique récurrente -->
    <div class="text-center pastel-baby-powder mb-6">
      <h2 class="text-xs sm:text-sm md:text-base font-normal">Thématique récurrente</h2>
      <p class="text-sm sm:text-base md:text-lg font-semibold text-black">À venir...</p>
    </div>

</div>

<!-- Boutons d'action -->
<div class="flex justify-center gap-4 mb-6 flex-nowrap">
  <a href="{% url 'dream_recorder' %}" 
     class="btn-ballon">
    Enregistrer un rêve
  </a>
  <a href="{% url 'dream_followup' %}" 
     class="btn-ballon">
    Suivi de mes rêves
  </a>
</div>

<!-- Séparateur -->
<hr class="border-t border-[#ede9f9] mb-6">

<!-- Grille des rêves -->
<div id="dream-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-1">
  {% for dream in dreams %}
    <div class="dream-tile hidden w-full aspect-square overflow-hidden rounded-md group transition-transform duration-300 hover:scale-105">
      <img
        src="{% if dream.image %}{{ dream.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}"
        alt="{% if dream.image %}Rêve{% else %}Pas d'image{% endif %}"
        class="w-full h-full object-cover {% if not dream.image %}opacity-50{% endif %}"
      >
    </div>
  {% empty %}
    <p class="col-span-full text-center text-gray-500 text-sm mt-6">
      Aucun rêve enregistré pour l'instant.
    </p>
  {% endfor %}
</div>

<!-- Lien Afficher plus -->
<div class="col-span-full flex justify-center mt-4">
  <button id="loadMoreBtn">
    <img src="{% static 'img/show_more_arrow.png' %}" alt="Afficher plus de rêves" class="h-10">
  </button>
</div>


<!-- Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tiles = document.querySelectorAll('.dream-tile');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    let currentIndex = 0;
    const initialDisplay = 18;
    const loadMoreStep = 12;

    function showNextChunk(step) {
      const nextIndex = Math.min(currentIndex + step, tiles.length);
      for (let i = currentIndex; i < nextIndex; i++) {
        tiles[i].classList.remove('hidden');
      }
      currentIndex = nextIndex;

      if (currentIndex >= tiles.length) {
        loadMoreBtn.style.display = 'none';
      }
    }

    showNextChunk(initialDisplay); // Affiche les 16 premiers au chargement
    loadMoreBtn.addEventListener('click', () => showNextChunk(loadMoreStep));
  });
</script>

{% endblock %}