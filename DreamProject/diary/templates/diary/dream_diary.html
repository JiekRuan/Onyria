{% extends 'diary/base.html' %}
{% load static %}

{% block title %}Journal de rêves{% endblock %}

{% block content %}

<!-- Bloc profil -->
<div class="flex flex-col items-center justify-center text-center gap-2 mb-6">

  <!-- Image de profil avec effet "trou" -->
  <div class="relative w-36 h-36 grey-border">
  <div class="rounded-full overflow-hidden w-full h-full">
    {% if user.profile_picture_url %}
      <img src="{{ user.profile_picture_url }}" alt="Profil"
          class="w-full h-full object-cover rounded-full" />
    {% else %}
      <img src="{% static 'img/profil_placeholder.png' %}" alt="Profil"
          class="w-full h-full object-cover rounded-full" />
    {% endif %}
    <div class="absolute inset-0 inset-shadow"></div>
  </div>
  </div>

  <!-- Nom -->
  <h2 class="text-[1.4rem] font-semibold text-gray-800">{{ user.username }}</h2>

    <!-- Bio avec guillemets -->
    <div class="relative w-full flex justify-center mb-2">
        <div class="relative flex items-center justify-center max-w-[70%]">
            <!-- Guillemet gauche -->
            <img src="{% static 'img/left_quotation_marks.png' %}" class="w-[1.45rem] mr-2 flex-shrink-0" />
            
            <!-- Zone de texte/input -->
            <div class="relative flex-1 min-w-0">
                <!-- Texte affiché -->
                <span id="bio-display" class="bio-editable block text-[1.05rem] text-black font-normal leading-tight text-center">
                    {{ user.bio|default:"Chaque nuit, une nouvelle aventure commence." }}
                </span>

                <!-- Champ input -->
                <form id="bio-form" method="post" action="{% url 'edit_bio' %}" class="hidden">
                {% csrf_token %}
                <input
                    type="text"
                    name="bio"
                    id="bio-input"
                    maxlength="180"
                    class="bio-input"
                    value="{{ user.bio }}"
                />
                </form>
            </div>
            
            <!-- Guillemet droit -->
            <img src="{% static 'img/right_quotation_marks.png' %}" class="w-[1.45rem] ml-2 flex-shrink-0" />
        </div>
    </div>
</div>  

<!-- Suivi personnel -->

<div class="grid grid-cols-3 gap-6 ">

    <!-- Rêves/cauchemars -->
    <div class="text-center pastel-yellow mb-6">
      <h2 class="text-xs sm:text-sm md:text-base font-normal">Profil onirique</h2>
      <p class="text-sm sm:text-base md:text-lg font-semibold text-black">{{ statut_reveuse }}</p>
      <p class="text-xs sm:text-xs md:text-sm text-gray-500 mt-1">
        {{ pourcentage_reveuse }}% de {{ label_reveuse }}
      </p>
    </div>

    <!-- Émotion dominante -->
    <div class="text-center pastel-vanilla mb-6">
      <h2 class="text-xs sm:text-sm md:text-base font-normal">Émotion dominante</h2>
      <p class="text-sm sm:text-base md:text-lg font-semibold text-black">{{ emotion_dominante }}</p>
      <p class="text-xs sm:text-xs md:text-sm text-gray-500 mt-1">
        dans {{ emotion_dominante_percentage }}% des cas
      </p>
    </div>

    <!-- Thématique récurrente -->
    <div class="text-center pastel-champagne mb-6">
      <h2 class="text-xs sm:text-sm md:text-base font-normal">Thématique récurrente</h2>
      <p class="text-sm sm:text-base md:text-lg font-semibold text-black">À venir...</p>
    </div>

</div>

<!-- Séparateur -->
<hr class="border-t border-[#ede9f9] mb-6">

<!-- Grille des rêves -->
<div id="dream-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-1">
  {% for dream in dreams %}
    <a href="{% url 'dream_detail' dream.id %}" class="dream-tile hidden w-full aspect-square overflow-hidden rounded-md transition-all duration-300 hover:scale-105 hover:z-10 cursor-pointer relative group">
      <img
        src="{% if dream.image_url %}{{ dream.image_url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}"
        alt="{% if dream.image_url %}Rêve du {{ dream.created_at|date:'d/m/Y' }}{% else %}Pas d'image{% endif %}"
        class="w-full h-full object-cover {% if not dream.image_url %}opacity-50{% endif %}"
      >
      <div class="absolute inset-0 bg-gray-800 bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex flex-col items-center justify-end pb-2">
         <!-- Bouton poubelle -->
        <button class="btn-ballon-icon opacity-0 group-hover:opacity-100 transition-opacity duration-200 mb-2" data-dream-id="{{ dream.id }}">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
        </button>
        <span class="text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity duration-300 mb-2">
          {{ dream.created_at|date:"d/m/Y" }}
        </span>
        
       
      </div>
    </a>
  {% empty %}
    <p class="col-span-full text-center text-gray-500 text-sm mt-6">
      Aucun rêve enregistré pour l'instant.
    </p>
  {% endfor %}
</div>

<!-- Lien Afficher plus -->
<div class="col-span-full flex justify-center mt-4">
  <button id="loadMoreBtn">
    <img src="{% static 'img/show_more_arrow.png' %}" alt="Afficher plus de rêves" class="h-10">
  </button>
</div>

<!-- Modal de suppression -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="pastel-baby-powder max-w-md w-full">
      <h3 class="text-lg font-semibold mb-4 text-center">Supprimer ce rêve ?</h3>
      <p class="text-sm text-gray-600 mb-6 text-center">Cette action est définitive et ne peut pas être annulée.</p>
      <div class="button-group-center">
        <button onclick="closeDeleteModal()" class="btn-ballon-sm">Annuler</button>
        <button id="confirmDeleteBtn" class="btn-ballon-sm">Supprimer</button>
      </div>
    </div>
  </div>
</div>

{% csrf_token %}


<!-- Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tiles = document.querySelectorAll('.dream-tile');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    let currentIndex = 0;
    const initialDisplay = 18;
    const loadMoreStep = 12;

    function showNextChunk(step) {
      const nextIndex = Math.min(currentIndex + step, tiles.length);
      for (let i = currentIndex; i < nextIndex; i++) {
        tiles[i].classList.remove('hidden');
      }
      currentIndex = nextIndex;

      if (currentIndex >= tiles.length) {
        loadMoreBtn.style.display = 'none';
      }
    }

    showNextChunk(initialDisplay); // Affiche les 18 premiers au chargement
    loadMoreBtn.addEventListener('click', () => showNextChunk(loadMoreStep));

    // Event listeners pour les boutons delete
    document.querySelectorAll('button[data-dream-id]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const dreamId = this.getAttribute('data-dream-id');
        showDeleteModal(dreamId);
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const bioDisplay = document.getElementById("bio-display");
    const bioForm = document.getElementById("bio-form");
    const bioInput = document.getElementById("bio-input");

    let originalValue = "";

    // Quand on clique sur le texte → mode édition
    bioDisplay.addEventListener("click", function () {
        originalValue = bioDisplay.textContent.trim();
        bioDisplay.classList.add("hidden");
        bioForm.classList.remove("hidden");
        bioInput.value = originalValue;
        bioInput.focus();
    });

    // Enter = envoi
    bioInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            bioForm.submit();
        }
    });

    // Clic à l'extérieur = enregistrement si modifié
    document.addEventListener("click", function (e) {
        if (!bioForm.contains(e.target) && e.target !== bioDisplay && !bioForm.classList.contains("hidden")) {
            const newValue = bioInput.value.trim();
            if (newValue !== originalValue) {
                bioForm.submit();
            } else {
                // Rien de changé → retour affichage
                bioForm.classList.add("hidden");
                bioDisplay.classList.remove("hidden");
            }
        }
    });
});

// Fonctions modal suppression
function showDeleteModal(dreamId) {
  document.getElementById('deleteModal').classList.remove('hidden');
  document.getElementById('confirmDeleteBtn').onclick = () => confirmDelete(dreamId);
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
}

async function confirmDelete(dreamId) {
  try {
    const response = await fetch(`/diary/delete/${dreamId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      }
    });
    
    if (response.ok) {
      // Recharger la page pour voir les changements
      location.reload();
    } else {
      alert('Erreur lors de la suppression');
    }
  } catch (error) {
    alert('Erreur réseau');
  }
  
  closeDeleteModal();
}

// Fermer modal avec Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeDeleteModal();
  }
});

</script>

{% endblock %}