{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Analyse vocale du r√™ve</title>
</head>
<body>
  <h1>Raconte ton r√™ve √† voix haute</h1>
  <button id="recordBtn">üé§ Enregistrer</button>

  <div id="timer" style="display: none">
    Temps: <span id="timerText">00:00</span>
  </div>

  <div id="status" style="display: none"></div>

  <h2>Transcription :</h2>
  <div id="transcriptionText"></div>

  <h3>√âmotion dominante</h3>
  <div id="emotionDominante"></div>

  <h3>Type de r√™ve</h3>
  <div id="dreamType"></div>

  <h3>Interpr√©tation</h3>
  <div id="interpretation"></div>

  <h3>Image g√©n√©r√©e</h3>
  <div id="imageRevee"></div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let startTime;
    let timerInterval;

    const recordBtn = document.getElementById("recordBtn");
    const timer = document.getElementById("timer");
    const timerText = document.getElementById("timerText");
    const status = document.getElementById("status");
    const transcriptionText = document.getElementById("transcriptionText");
    const emotionDominante = document.getElementById("emotionDominante");
    const dreamType = document.getElementById("dreamType");
    const interpretation = document.getElementById("interpretation");
    const imageRevee = document.getElementById("imageRevee");

    recordBtn.addEventListener("click", toggleRecording);

    async function toggleRecording() {
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = processRecording;

        mediaRecorder.start();
        isRecording = true;

        recordBtn.textContent = "‚èπÔ∏è Arr√™ter";
        timer.style.display = "block";
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        showStatus("Enregistrement en cours...");
      } catch (err) {
        showStatus("Erreur: Impossible d'acc√©der au microphone");
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        clearInterval(timerInterval);

        recordBtn.textContent = "‚è≥ Traitement...";
        timer.style.display = "none";
        showStatus("Traitement en cours...");
      }
    }

    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      timerText.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
    }

    async function processRecording() {
      try {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob);

        const response = await fetch("/diary/analyse_from_voice/", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          transcriptionText.textContent = result.transcription;

          emotionDominante.textContent = `${capitalize(result.dominant_emotion[0])} (${(result.dominant_emotion[1] * 100).toFixed(1)}%)`;

          dreamType.textContent = result.dream_type;

          interpretation.innerHTML = "";
          for (const [key, val] of Object.entries(result.interpretation)) {
            interpretation.innerHTML += `<p><strong>${capitalize(key)}</strong> : ${val}</p>`;
          }

          if (result.image_path) {
            imageRevee.innerHTML = `<img src="/static/${result.image_path}" alt="Image du r√™ve" style="max-width: 600px;" />`;
          }

          showStatus("Analyse termin√©e !");
        } else {
          showStatus("Erreur : " + result.error);
        }

      } catch (err) {
        showStatus("Erreur: " + err.message);
      }

      recordBtn.textContent = "üé§ Enregistrer";
    }

    function showStatus(message) {
      status.textContent = message;
      status.style.display = "block";
      setTimeout(() => {
        status.style.display = "none";
      }, 5000);
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  </script>
</body>
</html>
