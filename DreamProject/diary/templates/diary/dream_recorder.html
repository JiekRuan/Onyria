{% extends "diary/base.html" %}
{% load static %}

{% block title %}Analyse vocale du rêve{% endblock %}

{% block content %}

<!-- Titre -->
    <h1 class="text-3xl text-center text-black mb-8">Raconte ton rêve à voix haute</h1>

<!-- Bouton d'enregistrement -->
<div class="text-center">
  <button id="recordBtn" class="btn-ballon-sm">
    Enregistrer
  </button>
</div>

<!-- Timer -->
<div id="timer" class="text-center text-gray-600 mt-4 hidden text-xs sm:text-sm md:text-base font-normal">
  Temps : <span id="timerText" class="font-mono">00:00</span>
</div>

<!-- Statut -->
<div id="status" class="text-center text-sm sm:text-base md:text-lg text-gray-700 mb-6 hidden font-normal"></div>

<!-- Bloc transcription -->
<div class="mb-6 mt-6 hidden pastel-baby-powder p-4 rounded-xl shadow" id="sectionTranscription">
  <h2 class="text-sm sm:text-base md:text-lg font-semibold text-center mb-2">Transcription</h2>
  <div id="transcriptionText" class="text-black text-base sm:text-lg md:text-xl font-normal leading-relaxed text-center">
    Ton texte apparaîtra ici.
  </div>
</div>

<!-- Bloc émotion + type de rêve côte à côte -->
<div class="mb-6 hidden flex gap-4" id="sectionEmotionDream">
  <div class="pastel-purple w-1/2 p-4 rounded-xl shadow">
    <h3 class="text-sm sm:text-base md:text-lg font-semibold text-center mb-2">Émotion dominante</h3>
    <div id="emotionDominante" class="text-black text-base sm:text-lg md:text-xl font-normal leading-relaxed text-center"></div>
  </div>
  <div class="pastel-vanilla w-1/2 p-4 rounded-xl shadow">
    <h3 class="text-sm sm:text-base md:text-lg font-semibold text-center mb-2">Type de rêve</h3>
    <div id="dreamType" class="text-black text-base sm:text-lg md:text-xl font-normal leading-relaxed text-center"></div>
  </div>
</div>

<!-- Bloc interprétation -->
<div class="mb-6 hidden pastel-yellow p-4 rounded-xl shadow" id="sectionInterpretation">
  <h3 class="text-sm sm:text-base md:text-lg font-semibold text-center mb-2">Interprétation</h3>
  <div id="interpretation" class="text-black text-sm sm:text-base md:text-lg font-normal leading-relaxed space-y-4 text-left"></div>
</div>

<!-- Bloc image générée -->
<div id="sectionImage" class="hidden mb-2">
  <div id="imageRevee" class="flex justify-center"></div>
</div>

<!-- Boutons de navigation -->
<div id="sectionNavigation" class="flex justify-center gap-4 mt-6 flex-nowrap hidden">
  <a href="{% url 'dream_diary' %}" class="btn-ballon">Retour au journal</a>
  <a href="{% url 'dream_followup' %}" class="btn-ballon">Suivi de mes rêves</a>
</div>

<script>
  let mediaRecorder;
  let audioChunks = [];
  let isRecording = false;
  let startTime;
  let timerInterval;

  const recordBtn = document.getElementById("recordBtn");
  const timer = document.getElementById("timer");
  const timerText = document.getElementById("timerText");
  const status = document.getElementById("status");

  const transcriptionText = document.getElementById("transcriptionText");
  const emotionDominante = document.getElementById("emotionDominante");
  const dreamType = document.getElementById("dreamType");
  const interpretation = document.getElementById("interpretation");
  const imageRevee = document.getElementById("imageRevee");

  const sectionTranscription = document.getElementById("sectionTranscription");
  const sectionEmotionDream = document.getElementById("sectionEmotionDream");
  const sectionInterpretation = document.getElementById("sectionInterpretation");
  const sectionImage = document.getElementById("sectionImage");

  recordBtn.addEventListener("click", toggleRecording);

  async function toggleRecording() {
    if (!isRecording) {
      await startRecording();
    } else {
      stopRecording();
    }
  }

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = processRecording;

      mediaRecorder.start();
      isRecording = true;

      recordBtn.textContent = "Arrêter";
      timer.style.display = "block";
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    } catch (err) {
      showStatus("Erreur: Impossible d'accéder au microphone");
    }
  }

  function stopRecording() {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      isRecording = false;
      clearInterval(timerInterval);

      recordBtn.textContent = "Traitement...";
      timer.style.display = "none";
    }
  }

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    timerText.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
  }

  async function processRecording() {
    try {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
      const formData = new FormData();
      formData.append("audio", audioBlob);

      const response = await fetch("/diary/analyse_from_voice/", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();

      const emotionLabels = {
        heureux: "Heureux",
        anxieux: "Anxieux",
        triste: "Triste",
        en_colere: "En colère",
        fatigue: "Fatigué",
        apeure: "Apeuré",
        surpris: "Surpris",
        serein: "Serein"
      };

      if (result.success) {
        transcriptionText.textContent = result.transcription;
        sectionTranscription.style.display = "block";

        const rawEmotion = result.dominant_emotion[0];
        emotionDominante.textContent = emotionLabels[rawEmotion] || capitalize(rawEmotion);

        dreamType.textContent = capitalize(result.dream_type);

        sectionEmotionDream.style.display = "flex";

        for (const [key, val] of Object.entries(result.interpretation)) {
          const p = document.createElement("p");
          p.className = "text-left text-sm sm:text-base md:text-lg font-normal";
          const strong = document.createElement("strong");
          strong.textContent = capitalize(key);
          p.appendChild(strong);
          p.appendChild(document.createTextNode(` : ${val}`));
          interpretation.appendChild(p);
        }

        sectionInterpretation.style.display = "block";

        const imagePath = result.image_path || "{% static 'img/placeholder.png' %}";
        imageRevee.innerHTML = "";
        const img = document.createElement("img");
        img.src = imagePath;
        img.alt = "Image du rêve";
        img.className = "pastel-image w-full aspect-[4/3] object-cover mx-auto";
        imageRevee.appendChild(img);

        sectionImage.style.display = "block";

      } else {
        showStatus("Erreur : " + result.error);
      }

    } catch (err) {
      showStatus("Erreur: " + err.message);
    }

    recordBtn.style.display = "none";
    document.getElementById("sectionNavigation").style.display = "flex";
  }

  function showStatus(message) {
    status.textContent = message;
    status.style.display = "block";
    setTimeout(() => {
      status.style.display = "none";
    }, 5000);
  }

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
</script>

{% endblock %}
