{% extends "diary/base.html" %} 
{% load static %} 

{% block title %}Suivi de mes rêves{% endblock %} 

{% block content %}

<!-- En-tête principal -->
<div class="text-center mb-8">
  <h1 class="text-3xl text-black mb-2">Suivi de mes rêves</h1>
  <p class="text-gray-600 text-sm">
    Analysez l'évolution de vos rêves et découvrez vos patterns oniriques
  </p>
</div>

{% if has_data %}

<!-- Section 1: Types de rêves avec bouton filtrer -->
<div class="mb-8 relative">
  <!-- Bouton Filtrer -->
  <div class="absolute top-0 left-0 z-10">
    <button id="filterToggle" class="btn-ballon-sm flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
      </svg>
      Filtrer
    </button>
    
    <!-- Menu déroulant -->
    <div id="filterDropdown" class="absolute top-full left-0 mt-2 bg-white rounded-xl shadow-lg border border-gray-200 p-4 min-w-[320px] hidden z-20">
      <!-- Filtre période -->
      <div class="mb-4">
        <label class="block text-sm font-semibold text-black mb-2">Période :</label>
        <select id="periodSelect" class="filter-select w-full">
          <option value="all" {% if current_period == 'all' %}selected{% endif %}>Toutes les données</option>
          <option value="month" {% if current_period == 'month' %}selected{% endif %}>30 derniers jours</option>
          <option value="3months" {% if current_period == '3months' %}selected{% endif %}>3 derniers mois</option>
          <option value="6months" {% if current_period == '6months' %}selected{% endif %}>6 derniers mois</option>
          <option value="1year" {% if current_period == '1year' %}selected{% endif %}>Dernière année</option>
          <option value="custom" {% if current_period == 'custom' %}selected{% endif %}>Période personnalisée</option>
        </select>
      </div>
      
      <!-- Champs dates personnalisées -->
      <div id="customDateRange" class="mb-4 {% if current_period != 'custom' %}hidden{% endif %}">
        <label class="block text-sm font-semibold text-black mb-2">Dates personnalisées :</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="date" id="startDate" class="filter-input flex-1" 
                 value="{{ current_start_date|default:'' }}"
                 placeholder="Date début">
          <span class="text-sm text-gray-500 self-center">à</span>
          <input type="date" id="endDate" class="filter-input flex-1" 
                 value="{{ current_end_date|default:'' }}"
                 placeholder="Date fin">
        </div>
        <button id="applyCustomFilter" class="btn-ballon-sm mt-2 w-full">
          Appliquer
        </button>
      </div>
      
      <!-- Affichage période active -->
      <div class="text-center pt-2 border-t border-gray-100">
        <p class="text-xs text-gray-600">
          <span class="font-medium">Période :</span> {{ date_range_display }}
        </p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">
    Types de rêves
  </h2>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Graphique pourcentages -->
    <div class="pastel-vanilla">
      <h3 class="text-sm sm:text-base md:text-lg font-semibold mb-4 text-center">Répartition globale</h3>
      <div class="h-64 flex items-center justify-center">
        <canvas id="dreamTypePieChart" class="max-w-full max-h-full"></canvas>
      </div>
      <div class="mt-4 text-xs sm:text-sm text-gray-600 text-center">
        Total : {{ dream_type_stats.total }} rêve{{ dream_type_stats.total|pluralize }}
      </div>
    </div>

    <!-- Graphique temporalité -->
    <div class="pastel-baby-powder">
      <h3 class="text-sm sm:text-base md:text-lg font-semibold mb-4 text-center">
        Évolution dans le temps
      </h3>
      <div class="h-64 flex items-center justify-center">
        <canvas id="dreamTypeTimelineChart" class="max-w-full max-h-full"></canvas>
      </div>
      <div class="mt-4 text-xs sm:text-sm text-gray-600 text-center">
        Évolution par jour
      </div>
    </div>
  </div>
</div>

<!-- Séparateur -->
<hr class="border-t border-[#ede9f9] mb-8">

<!-- Section 2: Émotions dominantes -->
<div class="mb-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">
    Émotions dominantes
  </h2>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Graphique pourcentages émotions -->
    <div class="pastel-champagne">
      <h3 class="text-sm sm:text-base md:text-lg font-semibold mb-4 text-center">
        Répartition des émotions
      </h3>
      <div class="h-64 flex items-center justify-center">
        <canvas id="emotionsPieChart" class="max-w-full max-h-full"></canvas>
      </div>
      <div class="mt-4 text-xs sm:text-sm text-gray-600 text-center">
        {{ emotions_stats|length }} émotion{{ emotions_stats|length|pluralize }}
        identifiée{{ emotions_stats|length|pluralize }}
      </div>
    </div>

    <!-- Graphique temporalité émotions -->
    <div class="pastel-yellow">
      <h3 class="text-sm sm:text-base md:text-lg font-semibold mb-4 text-center">
        Évolution émotionnelle
      </h3>
      <div class="h-64 flex items-center justify-center">
        <canvas id="emotionsTimelineChart" class="max-w-full max-h-full"></canvas>
      </div>
      <div class="mt-4 text-xs sm:text-sm text-gray-600 text-center">
        Humeurs au fil du temps
      </div>
    </div>
  </div>
</div>

<!-- Avertissement -->
<div class="mt-8">
  <details class="ai-disclaimer">
    <summary class="ai-disclaimer__summary flex items-center gap-2">
      <img
        src="{% static 'img/warning.png' %}"
        class="w-4 h-4 md:w-5 md:h-5 align-middle"
        aria-hidden="true"
        alt=""
      />
      <span class="ai-disclaimer__title">Avertissement sur les statistiques</span>
    </summary>
    <div class="ai-disclaimer__content">
      <p>
        Ces statistiques sont générées automatiquement à partir de vos rêves
        enregistrés et analysés par IA. Elles visent à vous donner un aperçu de
        vos patterns oniriques mais ne constituent pas un diagnostic médical ou
        psychologique.
      </p>
      <p class="mt-2">
        L'interprétation de ces données doit se faire avec prudence et ne
        remplace en aucun cas l'avis d'un professionnel de santé.
      </p>
    </div>
  </details>
</div>

{% else %}

<!-- Message si pas de données -->
<div class="text-center py-12">
  <div class="pastel-baby-powder max-w-md mx-auto">
    <h3 class="text-lg sm:text-xl font-semibold mb-4">
      {% if current_period != 'all' %}
        Pas de données pour cette période
      {% else %}
        Pas encore de données
      {% endif %}
    </h3>
    <p class="text-xs sm:text-sm text-gray-600 mb-6 leading-relaxed">
      {% if current_period != 'all' %}
        Aucun rêve trouvé pour la période sélectionnée. Essayez d'élargir la plage de dates.
      {% else %}
        Enregistrez quelques rêves pour voir apparaître vos statistiques personnalisées !
      {% endif %}
    </p>
    {% if current_period != 'all' %}
      <button class="btn-ballon-sm mr-2" onclick="applyFilter('all')">
        Voir toutes les données
      </button>
    {% endif %}
    <a href="{% url 'dream_recorder' %}" class="btn-ballon-sm">
      Enregistrer un rêve
    </a>
  </div>
</div>

{% endif %}

<!-- CSS pour les filtres -->
<style>
/* Styles pour les éléments de filtre */
.filter-select {
  @apply px-3 py-2 text-sm rounded-lg 
         bg-white border border-gray-300 text-black font-normal
         focus:outline-none focus:ring-2 focus:border-gray-400 
         transition-all duration-150;
  font-family: 'Schibsted Grotesk', sans-serif;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
}

.filter-select:focus {
  --tw-ring-color: #d1d5db;
  border-color: #9ca3af;
}

.filter-input {
  @apply px-3 py-2 text-sm rounded-lg 
         bg-white border border-gray-300 text-black font-normal
         focus:outline-none focus:ring-2 focus:border-gray-400 
         transition-all duration-150;
  font-family: 'Schibsted Grotesk', sans-serif;
}

.filter-input:focus {
  --tw-ring-color: #d1d5db;
  border-color: #9ca3af;
}

/* Menu déroulant responsive */
#filterDropdown {
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Responsive adjustments */
@media (max-width: 1000px) {
  #filterDropdown {
    min-width: 600px;
    max-width: calc(100vw - 2rem);
  }
  
  .filter-select {
    font-size: 14px;
  }
  
  .filter-input {
    font-size: 14px;
  }
}

/* Assurer que le dropdown ne déborde pas sur mobile */
@media (max-width: 480px) {
  #filterDropdown {
    min-width: 260px;
    left: 0;
    right: 1rem;
  }
}

/* Animation pour le dropdown */
#filterDropdown {
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.2s ease-out;
}

#filterDropdown.show {
  opacity: 1;
  transform: translateY(0);
}

/* Cohérence typographique */
.filter-select,
.filter-input,
.filter-select option {
  font-family: 'Schibsted Grotesk', sans-serif;
}
</style>

<!-- Scripts pour les graphiques et filtres -->
<script src="{% static 'js/chart.min.js' %}"></script>
<script>
// Gestion des filtres
document.addEventListener('DOMContentLoaded', function() {
  const filterToggle = document.getElementById('filterToggle');
  const filterDropdown = document.getElementById('filterDropdown');
  const periodSelect = document.getElementById('periodSelect');
  const customDateRange = document.getElementById('customDateRange');
  const applyCustomBtn = document.getElementById('applyCustomFilter');

  // Toggle du menu déroulant
  if (filterToggle && filterDropdown) {
    filterToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      
      if (filterDropdown.classList.contains('hidden')) {
        filterDropdown.classList.remove('hidden');
        setTimeout(() => filterDropdown.classList.add('show'), 10);
      } else {
        filterDropdown.classList.remove('show');
        setTimeout(() => filterDropdown.classList.add('hidden'), 200);
      }
    });

    // Fermer le menu en cliquant à l'extérieur
    document.addEventListener('click', function(e) {
      if (!filterDropdown.contains(e.target) && !filterToggle.contains(e.target)) {
        filterDropdown.classList.remove('show');
        setTimeout(() => filterDropdown.classList.add('hidden'), 200);
      }
    });

    // Empêcher la fermeture en cliquant dans le menu
    filterDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }

  // Gestion du changement de période
  if (periodSelect) {
    periodSelect.addEventListener('change', function() {
      const selectedPeriod = this.value;
      
      if (selectedPeriod === 'custom') {
        customDateRange.classList.remove('hidden');
      } else {
        customDateRange.classList.add('hidden');
        applyFilter(selectedPeriod);
      }
    });
  }

  // Filtre personnalisé
  if (applyCustomBtn) {
    applyCustomBtn.addEventListener('click', function() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('Veuillez sélectionner une date de début et une date de fin.');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('La date de début doit être antérieure à la date de fin.');
        return;
      }
      
      applyCustomFilter(startDate, endDate);
    });
  }

  // Validation en temps réel des dates
  const startInput = document.getElementById('startDate');
  const endInput = document.getElementById('endDate');
  
  if (startInput && endInput) {
    [startInput, endInput].forEach(input => {
      input.addEventListener('change', function() {
        const startDate = startInput.value;
        const endDate = endInput.value;
        
        if (startDate && endDate) {
          if (new Date(startDate) > new Date(endDate)) {
            input.setCustomValidity('La date de début doit être antérieure à la date de fin');
            input.style.borderColor = '#ef4444';
          } else {
            input.setCustomValidity('');
            input.style.borderColor = '#d1d5db';
          }
        }
      });
    });
  }
});

function applyFilter(period) {
  const url = new URL(window.location);
  url.searchParams.set('period', period);
  url.searchParams.delete('start_date');
  url.searchParams.delete('end_date');
  window.location.href = url.toString();
}

function applyCustomFilter(startDate, endDate) {
  const url = new URL(window.location);
  url.searchParams.set('period', 'custom');
  url.searchParams.set('start_date', startDate);
  url.searchParams.set('end_date', endDate);
  window.location.href = url.toString();
}

{% if has_data %}
// Configuration des couleurs pour cohérence visuelle avec contraste amélioré
const colors = {
  reve: '#4e3f86',      // Votre couleur brand principale pour les rêves
  cauchemar: '#E6C98C',  // Couleur pastel-yellow plus foncée pour les cauchemars
  emotions: [
    '#4e3f86', '#E6C98C', '#D8D3C3', '#c7a96b',
    '#9a8472', '#b5a491', '#8b7355', '#a69684'
  ]
};

// Données des graphiques depuis Django
const dreamTypeStats = {{ dream_type_stats|safe }};
const dreamTypeTimeline = {{ dream_type_timeline|safe }};
const emotionsStats = {{ emotions_stats|safe }};
const emotionsTimeline = {{ emotions_timeline|safe }};
const emotionsList = {{ emotions_list|safe }};

// Configuration Chart.js par défaut
Chart.defaults.font.family = "'Schibsted Grotesk', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 15;

// 1. Graphique en secteurs - Types de rêves
const ctxPie = document.getElementById('dreamTypePieChart').getContext('2d');
new Chart(ctxPie, {
  type: 'pie',
  data: {
    labels: ['Rêves', 'Cauchemars'],
    datasets: [{
      data: [dreamTypeStats.percentages.rêve, dreamTypeStats.percentages.cauchemar],
      backgroundColor: [colors.reve, colors.cauchemar],
      borderWidth: 2,
      borderColor: '#ffffff',
      hoverBorderWidth: 3,
      hoverOffset: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 20,
          font: { size: 13, weight: '500' },
          color: '#374151'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0,0,0,0.8)',
        titleColor: '#ffffff',
        bodyColor: '#ffffff',
        borderColor: '#d1d5db',
        borderWidth: 1,
        cornerRadius: 8,
        displayColors: true,
        callbacks: {
          label: function(context) {
            return context.label + ': ' + context.parsed + '%';
          }
        }
      }
    },
    layout: {
      padding: 20
    }
  }
});

// 2. Graphique timeline - Types de rêves
const ctxTimeline = document.getElementById('dreamTypeTimelineChart').getContext('2d');
new Chart(ctxTimeline, {
  type: 'line',
  data: {
    labels: dreamTypeTimeline.map(d => new Date(d.date).toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit'
    })),
    datasets: [{
      label: 'Rêves',
      data: dreamTypeTimeline.map(d => d.rêve),
      borderColor: colors.reve,
      backgroundColor: colors.reve + '30',
      borderWidth: 3,
      tension: 0.4,
      fill: false,
      pointBackgroundColor: colors.reve,
      pointBorderColor: '#ffffff',
      pointBorderWidth: 2,
      pointRadius: 5,
      pointHoverRadius: 7
    }, {
      label: 'Cauchemars',
      data: dreamTypeTimeline.map(d => d.cauchemar),
      borderColor: colors.cauchemar,
      backgroundColor: colors.cauchemar + '30',
      borderWidth: 3,
      tension: 0.4,
      fill: false,
      pointBackgroundColor: colors.cauchemar,
      pointBorderColor: '#ffffff',
      pointBorderWidth: 2,
      pointRadius: 5,
      pointHoverRadius: 7
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: { 
          stepSize: 1,
          color: '#6b7280'
        },
        grid: {
          color: '#f3f4f6'
        }
      },
      x: {
        ticks: {
          color: '#6b7280'
        },
        grid: {
          color: '#f3f4f6'
        }
      }
    },
    plugins: {
      legend: {
        position: 'bottom',
        labels: { 
          padding: 20, 
          font: { size: 13, weight: '500' },
          color: '#374151'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0,0,0,0.8)',
        titleColor: '#ffffff',
        bodyColor: '#ffffff',
        borderColor: '#d1d5db',
        borderWidth: 1,
        cornerRadius: 8
      }
    },
    layout: {
      padding: 15
    }
  }
});

// 3. Graphique en secteurs - Émotions
if (Object.keys(emotionsStats).length > 0) {
  const ctxEmotions = document.getElementById('emotionsPieChart').getContext('2d');
  const emotionLabels = Object.keys(emotionsStats);
  const emotionData = emotionLabels.map(label => emotionsStats[label].percentage);

  new Chart(ctxEmotions, {
    type: 'pie',
    data: {
      labels: emotionLabels,
      datasets: [{
        data: emotionData,
        backgroundColor: colors.emotions.slice(0, emotionLabels.length),
        borderWidth: 3,
        borderColor: '#ffffff',
        hoverBorderWidth: 4,
        hoverOffset: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 11, weight: '500' },
            color: '#374151'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#d1d5db',
          borderWidth: 1,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + '%';
            }
          }
        }
      },
      layout: {
        padding: 15
      }
    }
  });
}

// 4. Graphique timeline - Émotions
if (emotionsTimeline.length > 0 && emotionsList.length > 0) {
  const ctxEmotionsTimeline = document.getElementById('emotionsTimelineChart').getContext('2d');

  const datasets = emotionsList.map((emotion, index) => ({
    label: emotion.label,
    data: emotionsTimeline.map(d => d[emotion.key] || 0),
    borderColor: colors.emotions[index % colors.emotions.length],
    backgroundColor: colors.emotions[index % colors.emotions.length] + '30',
    borderWidth: 3,
    tension: 0.4,
    fill: false,
    pointBackgroundColor: colors.emotions[index % colors.emotions.length],
    pointBorderColor: '#ffffff',
    pointBorderWidth: 2,
    pointRadius: 4,
    pointHoverRadius: 6
  }));

  new Chart(ctxEmotionsTimeline, {
    type: 'line',
    data: {
      labels: emotionsTimeline.map(d => new Date(d.date).toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit'
      })),
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            color: '#6b7280'
          },
          grid: {
            color: '#f3f4f6'
          }
        },
        x: {
          ticks: {
            color: '#6b7280'
          },
          grid: {
            color: '#f3f4f6'
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: { 
            padding: 12, 
            font: { size: 10, weight: '500' },
            color: '#374151'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#d1d5db',
          borderWidth: 1,
          cornerRadius: 8
        }
      },
      layout: {
        padding: 15
      }
    }
  });
  }

{% endif %}

</script>

{% endblock %}